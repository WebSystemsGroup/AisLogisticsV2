@using AisLogistics.App.Models.DTO.ReestrUnclaimedDocuments
@model List<ReestrCasesUnclaimedDocumentsDTO>

<div>
    <table class="table w-100">
        <thead>
            <tr>
                <th><input type="checkbox" data-check-main id="checkSelectedRowMain"></th>
                <th>Заявитель</th>
                <th>Адрес</th>
                <th>Контакты</th>
                <th>Номер обращения</th>
                <th>
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <div class="dropdown-item">
                                    <a class="w-100 d-block" href="javascript:void(0);" onclick="PrintReestr()">Печать</a>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <a class="w-100 d-block" href="javascript:void(0);" onclick="CaseAddStage()">Добавить Этап</a>
                                </div>
                            </li>
                            <li>
                                <div class="dropdown-item">
                                    <a class="w-100 d-block" href="javascript:void(0);" onclick="CaseAddComment()">Добавить комментарий</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody class="table-border-bottom-0" id="casesUnclaimedBody_Wrapper">
            @if (@Model.Any())
            {
                @foreach (var request in Model)
                {
                    <tr data-view-reestr-id="@request.DReestrId" data-service-id="@request.ServiceId" data-case-id="@request.CasesNumber">
                        <td><input type="checkbox" data-check id="checkSelectedRow"></td>
                        <td>@request.CustomerName</td>
                        <td>@request.CustomerAddress</td>
                        <td>
                            <p>@request.CustomerPhone1</p>
                            <p>@request.CustomerPhone2</p>
                        </td>
                        <td colspan="2">@request.CasesNumber</td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>


<script>
    $(function () {
        new PerfectScrollbar("#casesUnclaimedBody_Wrapper");

        $('#checkSelectedRowMain').change(function () {
            let value = $('#checkSelectedRowMain').prop("checked");
            $('[data-check]').each(function (i, el) {
                $(el).prop("checked", value)
            });
        });

        $('[data-check]').change(function () {
            if ($('#checkSelectedRowMain').prop("checked"))
                $('#checkSelectedRowMain').prop("checked", false);
        });
    });

    function CaseAddComment() {

        $.ajax({
            url: '/ReestrUnclaimedDocuments/CasesCommentsChangeModalAdd',
            type: 'POST',
            beforeSend: () => {
                $.pageBlock();
            },
            complete: () => {
                $.unblockUI();
            },
            success: function (content) {
                $('#modalContainerOver').html(content).modal('show');
            }
        });
    };

    function PrintReestr() {
        //let id = $('[data-view-reestr-id]').first().data('view-reestr-id');
        let id = '@ViewBag.Id';
        $.ajax({
            url: '/ReestrUnclaimedDocuments/UnclaimedDocumentsPrint',
            type: 'POST',
            data: { id: id },
            beforeSend: () => {
                $.pageBlock();
            },
            complete: () => {
                $.unblockUI();
            },
            success: function (data) {
                printPDF(data);
            }
        });
    };

    function CaseAddStage() {
        let mass = [];
        $('[data-check]').each(function (i, el) {
            if ($(el).prop("checked")) {
                mass.push($(el).parents('[data-service-id]').attr('data-service-id'));
            }
        });
        if (mass.length > 0) {
            $.ajax({
                url: '/ReestrUnclaimedDocuments/ServiceStageAddModal',
                type: 'POST',
                data: { id: mass },
                beforeSend: () => {
                    $.pageBlock();
                },
                complete: () => {
                    $.unblockUI();
                },
                success: function (content) {
                    $('#modalContainerOver').html(content).modal('show');
                }
            });
        }
        else {
            toastr['warning']('Выберите услуги для добавления Этапа', 'Предупреждение', {
                closeButton: true,
                tapToDismiss: false,
                rtl: isRtl
            });
        }

    };
</script>


